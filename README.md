# GIS局放监测系统 v1.4

## 系统简介

本系统是一个用于监测GIS设备局部放电的软件，提供实时数据显示和分析功能。系统基于PyQt5开发，集成了Modbus TCP通信、数据可视化和局部放电类型识别功能。

## 新增功能：局部放电类型识别与历史记录比对

系统集成了局部放电类型识别模块，可以对PRPD图进行分析，识别出局部放电的类型，包括：

- 电晕放电 (Corona)
- 颗粒放电 (Particle)
- 悬浮放电 (Floating)
- 沿面放电 (Surface)
- 气隙放电 (Void)

### 最新更新：历史记录查看与比对功能

v1.4版本新增历史记录查看与比对功能，支持：

- 查看所有历史识别记录及相应图像
- 按日期和局放类型筛选历史记录
- 选择两条记录进行比对分析，直观对比结果差异
- 自动计算识别结果一致性和时间差异
- 历史记录可视化展示，便于追踪设备状态变化

### 累加PRPD图与自动识别功能增强

v1.4.1版本增强了累加PRPD图与自动识别功能的兼容性：

- 修复了勾选累加PRPD图时自动识别功能保存单次图像的问题
- 确保在自动识别时保存的图像与屏幕显示的累加PRPD图一致
- 添加了详细的日志记录，帮助跟踪累加数据的使用状态
- 优化了自动识别功能启动逻辑，开启后立即进行第一次识别
- 改进了PRPD历史数据管理，保证模式切换时数据连续性
- 增强了异常处理，防止空数据导致程序异常

### 自动识别功能

v1.3版本添加的自动识别功能，无需手动点击识别按钮：

- 勾选"自动识别"选项即可开启自动识别功能
- 支持自定义识别间隔（1-60次更新）
- 自动将PRPD图保存至tmp_images目录，文件名包含时间戳
- 状态栏和日志区域显示识别结果和对应图像路径

## 系统启动

为了方便用户使用，系统提供了一键启动脚本：

1. 双击运行 `启动GIS局放监测系统.bat`
2. 脚本会自动启动局放类型识别API服务和主程序

## 使用方法

### 局部放电类型识别

1. 启动系统后，在左侧控制面板中找到「局放类型识别」模块
2. 点击「检查API服务」按钮，确认API服务状态为「已连接」
3. 使用方式：
   - **手动识别**：当PRPD图显示有效数据后，点击「识别当前局放类型」按钮
   - **自动识别**：勾选「自动识别」选项，系统将按照设定的间隔自动识别
4. 系统会分析PRPD图，并显示识别结果和置信度

### 历史记录查看与比对

1. 在「局放类型识别」模块中点击「查看历史记录」按钮
2. 在历史记录窗口中，可以：
   - 浏览所有历史识别记录，记录按时间倒序排列
   - 使用日历控件按日期筛选记录
   - 使用下拉菜单按局放类型筛选记录
   - 点击任意记录查看详细信息和图像
3. 比对功能使用：
   - 选择要比对的第一条记录，点击「选为左侧比对项」
   - 选择要比对的第二条记录，点击「选为右侧比对项」
   - 系统自动显示两条记录的图像和识别结果对比
   - 比对结论区域显示结果一致性分析和时间差计算
4. 可以点击「清除选择」按钮重新选择比对项
5. 点击「刷新数据」按钮更新历史记录列表

![系统界面预览](系统界面预览.png)
![系统界面预览](https://github.com/user-attachments/assets/a406dc92-3605-46d2-b95a-61e295b517b2)

## 主要功能

### 数据采集与显示
- 通过Modbus TCP协议实时采集GIS设备局部放电数据
- 显示放电次数总和和UHF_DB最大值等关键指标
- 实时更新系统状态和连接信息

### 数据可视化
- PRPD图（相位分辨局部放电图）：直观展示放电相位与幅值关系
- PRPS图（相位分辨局部放电谱）：三维展示放电相位、周期和幅值关系
- 支持参考波形显示，便于对比分析

### 数据管理
- 数据记录功能：可随时开始/停止记录监测数据
- 数据导出功能：将记录的数据导出为CSV格式，便于后续分析
- 支持自定义刷新率，灵活调整数据更新频率
- 数据表格视图：实时显示采集的数据，支持过滤、搜索和导出
- 系统日志：记录系统运行状态和数据采集过程

### 系统控制
- 设备连接/断开控制
- 显示内容自定义（PRPD图、PRPS图、参考波形等）
- 友好的用户界面，操作简单直观

## 系统要求

- 操作系统：Windows 7/10/11
- Python 3.6+
- 依赖库：
  - PyQt5
  - matplotlib
  - numpy
  - pymodbus
  - struct
  - csv

## 安装指南

1. 确保已安装Python 3.6或更高版本
2. 安装所需依赖库：
```bash
pip install pyqt5 matplotlib numpy pymodbus
```
3. 下载本项目代码
4. 运行主程序：
```bash
python 3_11_gis_modbusTCPGUI_v3.py
```

## 使用说明

### 连接设备
1. 确保监测设备已正确连接到网络
2. 默认连接地址为192.168.0.150:6789（可在代码中修改）
3. 点击"连接设备"按钮建立连接

### 数据监测
- 系统启动后会自动开始数据采集和显示
- 顶部面板显示系统信息和关键数据指标
- 图表区域实时更新PRPD图和PRPS图

### 数据记录与导出
1. 点击"开始记录"按钮开始记录数据
2. 数据记录过程中按钮变为"停止记录"
3. 点击"停止记录"结束数据记录
4. 点击"导出数据"将记录的数据导出为CSV文件
5. 启用自动识别功能时，系统会自动将PRPD图保存到tmp_images目录：
   - 图像命名格式：pd_image_YYYYMMDD_HHMMSS.jpg
   - 文件包含时间戳，便于历史对比和追溯
   - 系统日志会记录识别结果和对应图像路径

### 显示设置
- 通过控制面板的复选框控制是否显示PRPD图、PRPS图和参考波形
- 可调整刷新率（100-5000毫秒）以适应不同的监测需求
- 累加PRPD图模式：
  - 勾选"显示累加PRPD图"可启用累加模式
  - 累加模式会保留最近5次的数据，并在图表中叠加显示
  - 适合观察放电规律和长期趋势
  - 自动识别功能会根据当前模式（单次/累加）保存相应的图像
  - 累加模式下识别结果可能更加稳定，减少数据波动的影响
  - 系统日志会记录当前使用的模式和累加次数

### 数据表格与日志
1. 切换到"数据视图"选项卡查看实时数据表格和系统日志
2. 数据过滤功能：
   - 按数据类型过滤（放电次数、uhf_db、相位）
   - 文本搜索功能
   - 日期过滤
3. 表格管理：
   - 导出表格数据为CSV文件
   - 清空表格数据
   - 设置最大行数限制（防止内存占用过大）
4. 日志管理：
   - 清除日志
   - 保存日志到文本文件
   - 自动滚动设置

## 技术实现

### 通信协议
- 采用Modbus TCP协议与设备通信
- 自定义唤醒序列确保设备正常响应
- 支持多组寄存器数据的读取和解析

### 数据处理
- 实时解析设备返回的原始数据
- 支持int16和float32等多种数据类型
- 数据缓存和统计分析
- 数据过滤和搜索功能

### 用户界面
- 基于PyQt5构建现代化GUI界面
- 采用Matplotlib实现数据可视化
- 响应式布局适应不同屏幕尺寸
- 选项卡设计，分离图表视图和数据视图
- 标准输出重定向到日志区域

## 常见问题

1. **连接失败怎么办？**
   - 检查设备IP地址和端口是否正确
   - 确认网络连接是否正常
   - 尝试重启设备和软件

2. **数据显示异常？**
   - 检查设备是否正常工作
   - 确认寄存器配置是否正确
   - 尝试调整刷新率

3. **导出数据失败？**
   - 确保有足够的磁盘空间
   - 检查文件路径是否有写入权限
   - 确认是否已记录数据

4. **系统运行缓慢？**
   - 检查表格数据量是否过大，可适当减小最大行数限制
   - 调整刷新率，减少数据更新频率
   - 关闭不需要的显示内容（如PRPS图）

5. **PRPD图显示问题**
   - **问题1: colorbar不断累积**：在长时间运行后，PRPD图的colorbar会不断累积，导致界面混乱。
     - 解决方法：在`update_plot`方法中添加colorbar清除逻辑，确保每次更新前移除旧的colorbar。
     - 技术实现：添加`self.colorbar`属性跟踪当前colorbar，并在每次更新前检查并移除。
   
   - **问题2: PRPD图随时间变窄**：长时间运行后，PRPD图会逐渐变窄，显示空间被挤压。
     - 解决方法：使用`make_axes_locatable`为colorbar创建固定空间，避免挤压主图。
     - 技术实现：
       ```python
       from mpl_toolkits.axes_grid1 import make_axes_locatable
       divider = make_axes_locatable(self.ax1)
       cax = divider.append_axes("right", size="5%", pad=0.05)
       self.canvas.colorbar = self.canvas.fig.colorbar(scatter, cax=cax, label='幅值 (dB)')
       ```

   - **问题3: PRPS图挤压PRPD图**：在某些情况下，3D的PRPS图会挤压2D的PRPD图显示空间。
     - 解决方法：使用`GridSpec`控制子图布局，设置固定的宽度比例。
     - 技术实现：
       ```python
       from matplotlib.gridspec import GridSpec
       gs = GridSpec(1, 2, width_ratios=[1, 1])  # 1行2列，宽度比例1:1
       self.ax1 = self.fig.add_subplot(gs[0, 0])  # 左侧PRPD图
       self.ax2 = self.fig.add_subplot(gs[0, 1], projection='3d')  # 右侧PRPS图
       ```

6. **自动识别功能问题**
   - **问题1: 自动识别不工作？**
     - 确保已勾选"自动识别"选项
     - 确认API服务已成功连接（状态显示为"已连接"）
     - 检查tmp_images目录是否存在且有写入权限
   
   - **问题2: 识别结果不准确？**
     - 确保PRPD图中有足够的数据点
     - 尝试调整显示设置，关闭累加PRPD图模式
     - 升级SVM模型，提高识别准确率
   
   - **问题3: tmp_images目录空间占用过大？**
     - 定期清理不需要的历史图像
     - 可以编写简单脚本，保留最近N天的图像，自动删除过期图像
     
   - **问题4: 累加PRPD图与自动识别兼容问题？**
     - v1.4.1版本已修复此问题，确保使用最新版本
     - 如果仍有问题，检查日志中是否显示"使用累加PRPD图进行识别"的信息
     - 累加模式初次使用时需要多次更新才能积累足够的历史数据
     - 可以尝试先关闭自动识别，等累积一定次数的数据后再开启自动识别

7. **历史记录查看与比对功能问题**
   - **问题1: 历史记录显示不完整？**
     - 确保识别过程成功完成，且结果已保存到recognition_results.json文件
     - 检查tmp_images目录中的图像文件是否存在
     - 尝试点击"刷新数据"按钮更新历史记录列表
   
   - **问题2: 无法按日期筛选？**
     - 确保系统时间正确设置
     - 检查记录的时间戳格式是否正确（应为"YYYY-MM-DD HH:MM:SS"格式）
     - 尝试使用"清除筛选"功能后重新筛选
   
   - **问题3: 比对结论不准确？**
     - 确保两个选中的历史记录内容完整且有效
     - 检查识别结果的置信度是否过低，置信度过低可能导致结论不可靠
     - 如果出现格式解析错误，请检查识别结果文件格式是否正确

## 开发者信息

本系统由电力设备监测团队开发，用于GIS设备局部放电监测和分析。

## 版本历史

- v1.4 (当前版本)：
  - 新增历史记录查看与比对功能
  - 支持查看所有历史识别记录及相应图像
  - 按日期和局放类型筛选历史记录
  - 选择两条记录进行比对分析，直观对比结果差异
  - 自动计算识别结果一致性和时间差异
  - 历史记录可视化展示，便于追踪设备状态变化
- v1.3：
  - 新增自动识别功能，无需手动点击识别按钮
  - 支持自定义识别间隔（1-60次更新）
  - 自动保存PRPD图到tmp_images目录，文件名包含时间戳
  - 优化图像保存逻辑，仅保存PRPD图，提高识别准确率
- v1.2：添加数据记录和导出功能，优化界面，增加数据表格和日志功能
- v1.1：增加PRPS图显示，改进数据处理
- v1.0：基础版本，实现数据采集和PRPD图显示

## 许可证

本软件仅供内部使用，未经授权不得分发或商用。

## 联系方式

如有问题或建议，请联系：
- 电子邮件：support@gismonitoring.com
- 技术支持热线：400-123-4567
